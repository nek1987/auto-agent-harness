# ============================================================================
# Auto-Agent-Harness Docker Compose
# ============================================================================
#
# Production deployment configuration with dual authentication support.
#
# AUTHENTICATION MODES:
# ====================
#
# Mode 1: API Key (Default)
#   Set ANTHROPIC_API_KEY in .env file
#   docker-compose up -d
#
# Mode 2: OAuth Subscription (Local)
#   Run: ./scripts/setup-docker-auth.sh --oauth-mount
#   docker-compose up -d
#
# Mode 3: OAuth Subscription (Remote)
#   Run: ./scripts/setup-docker-auth.sh --oauth-extract
#   Copy project to server, then: docker-compose up -d
#
# Quick Setup:
#   ./scripts/setup-docker-auth.sh --interactive
#
# ============================================================================

services:
  auto-agent-harness:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: auto-agent-harness
    restart: unless-stopped

    ports:
      - "${PORT:-8888}:8888"

    environment:
      # Application Authentication (for UI login)
      - AUTH_ENABLED=${AUTH_ENABLED:-true}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - DEFAULT_ADMIN_PASSWORD=${DEFAULT_ADMIN_PASSWORD:-admin}

      # Claude API Authentication (choose one method)
      # Method 1: API Key (pay-per-token)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      # Method 2: OAuth - mount ~/.claude volume (see below)

      # Path security
      - ALLOWED_ROOT_DIRECTORY=/workspace
      - DATA_DIR=/app/data
      - REQUIRE_LOCALHOST=false

      # Server
      - HOST=0.0.0.0
      - PORT=8888

      # Webhooks (optional)
      - PROGRESS_N8N_WEBHOOK_URL=${PROGRESS_N8N_WEBHOOK_URL:-}

    volumes:
      # Persistent data storage
      - autocoder-data:/app/data

      # Workspace for projects
      - ${WORKSPACE_DIR:-./workspace}:/workspace

      # OAuth Credentials (uncomment ONE of these for OAuth mode):
      #
      # Option A: Mount host credentials (local Docker)
      # - ${HOME}/.claude:/home/autocoder/.claude:ro
      #
      # Option B: Mount extracted credentials (remote server)
      # - ./.docker-credentials:/home/autocoder/.claude:ro

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8888/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # Resource limits
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M

    # Security options
    security_opt:
      - no-new-privileges:true
    read_only: false
    tmpfs:
      - /tmp

volumes:
  autocoder-data:
    driver: local

# ============================================================================
# Usage Examples
# ============================================================================
#
# QUICK START (Interactive):
#   ./scripts/setup-docker-auth.sh
#
# API KEY MODE:
#   echo "ANTHROPIC_API_KEY=sk-ant-xxx" >> .env
#   echo "JWT_SECRET_KEY=$(python3 -c 'import secrets;print(secrets.token_hex(32))')" >> .env
#   docker-compose up -d
#
# OAUTH MODE (Local):
#   ./scripts/setup-docker-auth.sh --oauth-mount
#   docker-compose up -d
#
# OAUTH MODE (Remote Server):
#   ./scripts/setup-docker-auth.sh --oauth-extract
#   # Copy project to server
#   docker-compose up -d
#
# COMMON COMMANDS:
#   docker-compose up -d              # Start
#   docker-compose logs -f            # View logs
#   docker-compose down               # Stop
#   docker-compose build --no-cache   # Rebuild
#
# CUSTOM WORKSPACE:
#   WORKSPACE_DIR=/path/to/projects docker-compose up -d
#
# ============================================================================
